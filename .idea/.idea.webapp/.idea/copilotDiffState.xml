<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/webapp/Pages/SendApplication.cshtml">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/webapp/Pages/SendApplication.cshtml" />
              <option name="originalContent" value="@page&#10;@model webapp.Pages.SendApplicationModel&#10;@{&#10;    ViewData[&quot;Title&quot;] = &quot;Złóż wniosek&quot;;&#10;    Layout = &quot;~/Pages/Shared/_Layout.cshtml&quot;;&#10;}&#10;&#10;&lt;h1&gt;Złóż wniosek o uprawnienia&lt;/h1&gt;&#10;&lt;hr /&gt;&#10;&#10;&lt;!-- Lista zgłoszeń --&gt;&#10;@if (Model.PendingMessages.Any())&#10;{&#10;    &lt;h3&gt;Lista zgłoszeń&lt;/h3&gt;&#10;    &lt;table class=&quot;table&quot;&gt;&#10;        &lt;thead&gt;&#10;            &lt;tr&gt;&#10;                &lt;th&gt;Typ&lt;/th&gt;&#10;                &lt;th&gt;Nazwa&lt;/th&gt;&#10;                &lt;th&gt;Uprawnienie&lt;/th&gt;&#10;                &lt;th&gt;Uwagi&lt;/th&gt;&#10;                &lt;th&gt;Akcje&lt;/th&gt;&#10;            &lt;/tr&gt;&#10;        &lt;/thead&gt;&#10;        &lt;tbody&gt;&#10;            @foreach (var message in Model.PendingMessages)&#10;            {&#10;                &lt;tr&gt;&#10;                    &lt;td&gt;&lt;span&gt;@(message.DeviceId.HasValue ? &quot;Urządzenie &quot; : &quot;Program &quot;) @(message.DeviceId.HasValue ? &quot;- &quot; + Model.GetDeviceType(message.DeviceId.Value) : &quot;&quot;) &lt;/span&gt;&lt;/td&gt;&#10;                    &lt;td&gt;@(message.DeviceId.HasValue ? Model.GetDeviceName(message.DeviceId.Value) : Model.GetProgramName(message.ProgramId.Value))&lt;/td&gt;&#10;                    &lt;td&gt;@(message.DeviceId.HasValue ? &quot;Nie dotyczy&quot; : Model.GetPermissionName(message.PermissionId ?? 0))&lt;/td&gt;&#10;                    &lt;td&gt;@message.MessageText&lt;/td&gt;&#10;                    &lt;td&gt;&#10;                        &lt;form method=&quot;post&quot; asp-page-handler=&quot;RemoveMessage&quot;&gt;&#10;                            &lt;input type=&quot;hidden&quot; name=&quot;MessageIndex&quot; value=&quot;@Model.PendingMessages.IndexOf(message)&quot; /&gt;&#10;                            &lt;input type=&quot;hidden&quot; name=&quot;MessageText&quot; value=&quot;@Model.MessageText&quot; /&gt;&#10;                            &lt;input type=&quot;hidden&quot; name=&quot;ExpireDate&quot; value=&quot;@(Model.ExpireDate?.ToString(&quot;yyyy-MM-dd&quot;) ?? &quot;&quot;)&quot; /&gt;&#10;                            &lt;button type=&quot;submit&quot; class=&quot;btn btn-danger btn-sm&quot;&gt;Usuń&lt;/button&gt;&#10;                        &lt;/form&gt;&#10;                    &lt;/td&gt;&#10;                &lt;/tr&gt;&#10;            }&#10;        &lt;/tbody&gt;&#10;    &lt;/table&gt;&#10;}&#10;else&#10;{&#10;    &lt;p&gt;Brak zgłoszeń w liście.&lt;/p&gt;&#10;}&#10;&#10;&lt;hr /&gt;&#10;&#10;&#10;&lt;!-- Formularz dodawania zgłoszenia --&gt;&#10;&lt;h3&gt;Dodaj zgłoszenie&lt;/h3&gt;&#10;&lt;form method=&quot;post&quot; asp-page-handler=&quot;AddMessage&quot;&gt;&#10;    &lt;div class=&quot;mb-3&quot;&gt;&#10;        &lt;label for=&quot;Type&quot; class=&quot;form-label&quot;&gt;Typ zgłoszenia&lt;/label&gt;&#10;        &lt;select id=&quot;Type&quot; name=&quot;Type&quot; class=&quot;form-select&quot; onchange=&quot;toggleFields()&quot;&gt;&#10;            &lt;option value=&quot;Program&quot;&gt;Program / zasób&lt;/option&gt;&#10;            &lt;option value=&quot;Device&quot;&gt;Urządzenie&lt;/option&gt;&#10;        &lt;/select&gt;&#10;    &lt;/div&gt;&#10;&#10;    &lt;div id=&quot;ProducerFields&quot; class=&quot;mb-3&quot; style=&quot;display: none&quot;&gt;&#10;        &lt;label for=&quot;ProducerId&quot; class=&quot;form-label&quot;&gt;Wybierz producenta&lt;/label&gt;&#10;        &lt;select id=&quot;ProducerId&quot; name=&quot;ProducerId&quot; class=&quot;form-select&quot; onchange=&quot;loadPrograms(this.value)&quot;&gt;&#10;            &lt;option value=&quot;&quot;&gt;-- Wybierz producenta --&lt;/option&gt;&#10;            @foreach (var producer in Model.ProducerSelectList)&#10;            {&#10;                &lt;option value=&quot;@producer.Value&quot;&gt;@producer.Text&lt;/option&gt;&#10;            }&#10;        &lt;/select&gt;&#10;    &lt;/div&gt;&#10;&#10;    &lt;div id=&quot;ProgramFields&quot; class=&quot;mb-3&quot; &gt;&#10;        &lt;label for=&quot;ProgramId&quot; class=&quot;form-label&quot;&gt;Program / zasób&lt;/label&gt;&#10;        &lt;select id=&quot;ProgramId&quot; name=&quot;ProgramId&quot; class=&quot;form-select&quot; onchange=&quot;loadPermissions(this.value)&quot;&gt;&#10;            &lt;option value=&quot;&quot;&gt;-- Wybierz program / zasób --&lt;/option&gt;&#10;            @foreach (var program in Model.ProgramSelectList)&#10;            {&#10;                &lt;option value=&quot;@program.Value&quot;&gt;@program.Text&lt;/option&gt;&#10;            }&#10;        &lt;/select&gt;&#10;    &lt;/div &gt;&#10;&#10;    &lt;div id=&quot;PermissionFields&quot; class=&quot;mb-3&quot; style=&quot;display: block;&quot; &gt;&#10;        &lt;label for=&quot;PermissionId&quot; class=&quot;form-label&quot;&gt;Wybierz uprawnienie&lt;/label&gt;&#10;        &lt;select id=&quot;PermissionId&quot; name=&quot;PermissionId&quot; class=&quot;form-select&quot;&gt;&#10;            &lt;option value=&quot;&quot;&gt;-- Wybierz uprawnienie --&lt;/option&gt;&#10;        &lt;/select&gt;&#10;    &lt;/div&gt;&#10;&#10;    &lt;div id=&quot;DeviceTypeFields&quot; class=&quot;mb-3&quot; style=&quot;display: none;&quot;&gt;&#10;        &lt;label for=&quot;DeviceTypeId&quot; class=&quot;form-label&quot;&gt;Wybierz typ urządzenia&lt;/label&gt;&#10;        &lt;select id=&quot;DeviceTypeId&quot; name=&quot;DeviceTypeId&quot; class=&quot;form-select&quot; onchange=&quot;loadDevices(this.value)&quot;&gt;&#10;            &lt;option value=&quot;&quot;&gt;-- Wybierz typ urządzenia --&lt;/option&gt;&#10;            @foreach (var deviceType in Model.DeviceTypeSelectList)&#10;            {&#10;                &lt;option value=&quot;@deviceType.Value&quot;&gt;@deviceType.Text&lt;/option&gt;&#10;            }&#10;        &lt;/select&gt;&#10;    &lt;/div&gt;&#10;&#10;    @* &lt;div class=&quot;mb-3&quot;&gt; *@&#10;    @*     &lt;label for=&quot;MessageText&quot; class=&quot;form-label&quot;&gt;Uwagi do wniosku (opcjonalne, max 50 znaków)&lt;/label&gt; *@&#10;    @*     &lt;textarea id=&quot;MessageText&quot; name=&quot;MessageText&quot; class=&quot;form-control&quot; maxlength=&quot;50&quot;&gt;&lt;/textarea&gt; *@&#10;    @* &lt;/div&gt; *@&#10;    &lt;div id=&quot;DeviceFields&quot; class=&quot;mb-3&quot; style=&quot;display: none;&quot;&gt;&#10;        &lt;label for=&quot;DeviceId&quot; class=&quot;form-label&quot;&gt;Wybierz urządzenie&lt;/label&gt;&#10;        &lt;select id=&quot;DeviceId&quot; name=&quot;DeviceId&quot; class=&quot;form-select&quot;&gt;&#10;            &lt;option value=&quot;&quot;&gt;-- Wybierz urządzenie --&lt;/option&gt;&#10;        &lt;/select&gt;&#10;    &lt;/div&gt;&#10;    &lt;input type=&quot;hidden&quot; name=&quot;MessageText&quot; value=&quot;@Model.MessageText&quot; /&gt;&#10;    &lt;input type=&quot;hidden&quot; name=&quot;ExpireDate&quot; value=&quot;@(Model.ExpireDate?.ToString(&quot;yyyy-MM-dd&quot;) ?? &quot;&quot;)&quot; /&gt;&#10;    &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;Dodaj do listy&lt;/button&gt;&#10;    &#10;    &#10;&lt;/form&gt;&#10;&#10;&lt;hr /&gt;&#10;&#10;&lt;label for=&quot;MessageText&quot; class=&quot;form-label&quot;&gt;Uwagi do wniosku (opcjonalne, max 50 znaków)&lt;/label&gt;&#10;&lt;textarea id=&quot;MessageText&quot; name=&quot;MessageText&quot; class=&quot;form-control&quot; maxlength=&quot;50&quot;&gt;@Model.MessageText&lt;/textarea&gt;&#10;&#10;&lt;div class=&quot;mb-3 mt-2&quot;&gt;&#10;    &lt;label for=&quot;ExpireDate&quot; class=&quot;form-label&quot;&gt;Data wygaśnięcia wniosku&lt;/label&gt;&#10;    &lt;input type=&quot;date&quot; id=&quot;ExpireDate&quot; name=&quot;ExpireDate&quot; class=&quot;form-control&quot; value=&quot;@(Model.ExpireDate?.ToString(&quot;yyyy-MM-dd&quot;) ?? &quot;&quot;)&quot; /&gt;&#10;&lt;/div&gt;&#10;&#10;&lt;hr /&gt;&#10;&lt;!-- Przycisk wysyłania zgłoszenia --&gt;&#10;&lt;form method=&quot;post&quot; asp-page-handler=&quot;SubmitApplication&quot;&gt;&#10;    &lt;button type=&quot;submit&quot; class=&quot;btn btn-success&quot;&gt;Wyślij zgłoszenie&lt;/button&gt;&#10;&lt;/form&gt;&#10;&#10;@section Scripts {&#10;    &lt;script&gt;&#10;        function loadDevices(deviceTypeId) {&#10;            const deviceSelect = document.getElementById(&quot;DeviceId&quot;);&#10;            deviceSelect.innerHTML = '&lt;option value=&quot;&quot;&gt;-- Wybierz urządzenie --&lt;/option&gt;';&#10;&#10;            if (deviceTypeId) {&#10;                fetch(`/SendApplication?handler=Devices&amp;deviceTypeId=${deviceTypeId}`)&#10;                    .then(response =&gt; response.json())&#10;                    .then(data =&gt; {&#10;                        if (data.success) {&#10;                            data.devices.forEach(device =&gt; {&#10;                                const option = document.createElement(&quot;option&quot;);&#10;                                option.value = device.id;&#10;                                option.textContent = device.name;&#10;                                deviceSelect.appendChild(option);&#10;                            });&#10;                        } else {&#10;                            alert(data.message || &quot;Wystąpił błąd podczas pobierania urządzeń.&quot;);&#10;                        }&#10;                    })&#10;                    .catch(error =&gt; {&#10;                        console.error(&quot;Błąd:&quot;, error);&#10;                        alert(&quot;Nie udało się pobrać urządzeń.&quot;);&#10;                    });&#10;            }&#10;        }&#10;    &lt;/script&gt;&#10;    &lt;script&gt;&#10;        function toggleFields() {&#10;            const type = document.getElementById(&quot;Type&quot;).value;&#10;            document.getElementById(&quot;ProgramFields&quot;).style.display = type === &quot;Program&quot; ? &quot;block&quot; : &quot;none&quot;;&#10;&#9;&#9;&#9;document.getElementById(&quot;ProducerFields&quot;).style.display = type === &quot;Program&quot; ? &quot;none&quot; : &quot;none&quot;;&#10;            document.getElementById(&quot;PermissionFields&quot;).style.display = type === &quot;Program&quot; ? &quot;block&quot; : &quot;none&quot;;&#10;            document.getElementById(&quot;DeviceFields&quot;).style.display = type === &quot;Device&quot; ? &quot;block&quot; : &quot;none&quot;;&#10;            document.getElementById(&quot;DeviceTypeFields&quot;).style.display = type === &quot;Device&quot; ? &quot;block&quot; : &quot;none&quot;&#10;        }&#10;&#10;        function loadPermissions(programId) {&#10;            const permissionSelect = document.getElementById(&quot;PermissionId&quot;);&#10;            permissionSelect.innerHTML = '&lt;option value=&quot;&quot;&gt;-- Wybierz uprawnienie --&lt;/option&gt;';&#10;&#10;            if (programId) {&#10;                fetch(`/SendApplication?handler=Permissions&amp;programId=${programId}`)&#10;                    .then(response =&gt; response.json())&#10;                    .then(data =&gt; {&#10;                        if (data.success) {&#10;                            data.permissions.forEach(permission =&gt; {&#10;                                const option = document.createElement(&quot;option&quot;);&#10;                                option.value = permission.id;&#10;                                option.textContent = permission.name;&#10;                                permissionSelect.appendChild(option);&#10;                            });&#10;                        } else {&#10;                            alert(data.message || &quot;Wystąpił błąd podczas pobierania uprawnień.&quot;);&#10;                        }&#10;                    })&#10;                    .catch(error =&gt; {&#10;                        console.error(&quot;Błąd:&quot;, error);&#10;                        alert(&quot;Nie udało się pobrać uprawnień.&quot;);&#10;                    });&#10;            }&#10;        }&#10;        function loadPrograms(programId) {&#10;            const permissionSelect = document.getElementById(&quot;ProgramId&quot;);&#10;            permissionSelect.innerHTML = '&lt;option value=&quot;&quot;&gt;-- Wybierz program / zasób --&lt;/option&gt;';&#10;            const permissionsSelect = document.getElementById(&quot;PermissionId&quot;);&#10;            permissionsSelect.innerHTML = '&lt;option value=&quot;&quot;&gt;-- Wybierz uprawnienie --&lt;/option&gt;';&#10;            if (programId) {&#10;                fetch(`/SendApplication?handler=Programs&amp;programId=${programId}`)&#10;                    .then(response =&gt; response.json())&#10;                    .then(data =&gt; {&#10;                        if (data.success) {&#10;                            data.permissions.forEach(permission =&gt; {&#10;                                const option = document.createElement(&quot;option&quot;);&#10;                                option.value = permission.id;&#10;                                option.textContent = permission.name;&#10;                                permissionSelect.appendChild(option);&#10;                            });&#10;                        } else {&#10;                            alert(data.message || &quot;Wystąpił błąd podczas pobierania programów / zasobów.&quot;);&#10;                        }&#10;                    })&#10;                    .catch(error =&gt; {&#10;                        console.error(&quot;Błąd:&quot;, error);&#10;                        alert(&quot;Nie udało się pobrać programów / zasobów.&quot;);&#10;                    });&#10;            }&#10;        }&#10;    &lt;/script&gt;&#10;}" />
              <option name="updatedContent" value="@page&#10;@model webapp.Pages.SendApplicationModel&#10;@{&#10;    ViewData[&quot;Title&quot;] = &quot;Złóż wniosek&quot;;&#10;    Layout = &quot;~/Pages/Shared/_Layout.cshtml&quot;;&#10;}&#10;&#10;&lt;h1&gt;Złóż wniosek o uprawnienia&lt;/h1&gt;&#10;&lt;hr /&gt;&#10;&#10;&lt;!-- Lista zgłoszeń --&gt;&#10;@if (Model.PendingMessages.Any())&#10;{&#10;    &lt;h3&gt;Lista zgłoszeń&lt;/h3&gt;&#10;    &lt;table class=&quot;table&quot;&gt;&#10;        &lt;thead&gt;&#10;            &lt;tr&gt;&#10;                &lt;th&gt;Typ&lt;/th&gt;&#10;                &lt;th&gt;Nazwa&lt;/th&gt;&#10;                &lt;th&gt;Uprawnienie&lt;/th&gt;&#10;                &lt;th&gt;Uwagi&lt;/th&gt;&#10;                &lt;th&gt;Akcje&lt;/th&gt;&#10;            &lt;/tr&gt;&#10;        &lt;/thead&gt;&#10;        &lt;tbody&gt;&#10;            @foreach (var message in Model.PendingMessages)&#10;            {&#10;                &lt;tr&gt;&#10;                    &lt;td&gt;&lt;span&gt;@(message.DeviceId.HasValue ? &quot;Urządzenie &quot; : &quot;Program &quot;) @(message.DeviceId.HasValue ? &quot;- &quot; + Model.GetDeviceType(message.DeviceId.Value) : &quot;&quot;) &lt;/span&gt;&lt;/td&gt;&#10;                    &lt;td&gt;@(message.DeviceId.HasValue ? Model.GetDeviceName(message.DeviceId.Value) : Model.GetProgramName(message.ProgramId.Value))&lt;/td&gt;&#10;                    &lt;td&gt;@(message.DeviceId.HasValue ? &quot;Nie dotyczy&quot; : Model.GetPermissionName(message.PermissionId ?? 0))&lt;/td&gt;&#10;                    &lt;td&gt;@message.MessageText&lt;/td&gt;&#10;                    &lt;td&gt;&#10;                        &lt;form method=&quot;post&quot; asp-page-handler=&quot;RemoveMessage&quot;&gt;&#10;                            &lt;input type=&quot;hidden&quot; name=&quot;MessageIndex&quot; value=&quot;@Model.PendingMessages.IndexOf(message)&quot; /&gt;&#10;                            &lt;input type=&quot;hidden&quot; name=&quot;MessageText&quot; value=&quot;@Model.MessageText&quot; /&gt;&#10;                            &lt;input type=&quot;hidden&quot; name=&quot;ExpireDate&quot; value=&quot;@(Model.ExpireDate?.ToString(&quot;yyyy-MM-dd&quot;) ?? &quot;&quot;)&quot; /&gt;&#10;                            &lt;button type=&quot;submit&quot; class=&quot;btn btn-danger btn-sm&quot;&gt;Usuń&lt;/button&gt;&#10;                        &lt;/form&gt;&#10;                    &lt;/td&gt;&#10;                &lt;/tr&gt;&#10;            }&#10;        &lt;/tbody&gt;&#10;    &lt;/table&gt;&#10;}&#10;else&#10;{&#10;    &lt;p&gt;Brak zgłoszeń w liście.&lt;/p&gt;&#10;}&#10;&#10;&lt;hr /&gt;&#10;&#10;&#10;&lt;!-- Formularz dodawania zgłoszenia --&gt;&#10;&lt;h3&gt;Dodaj zgłoszenie&lt;/h3&gt;&#10;&lt;form method=&quot;post&quot; asp-page-handler=&quot;AddMessage&quot; id=&quot;addMessageForm&quot;&gt;&#10;    &lt;div class=&quot;mb-3&quot;&gt;&#10;        &lt;label for=&quot;Type&quot; class=&quot;form-label&quot;&gt;Typ zgłoszenia&lt;/label&gt;&#10;        &lt;select id=&quot;Type&quot; name=&quot;Type&quot; class=&quot;form-select&quot; onchange=&quot;toggleFields()&quot;&gt;&#10;            &lt;option value=&quot;Program&quot;&gt;Program / zasób&lt;/option&gt;&#10;            &lt;option value=&quot;Device&quot;&gt;Urządzenie&lt;/option&gt;&#10;        &lt;/select&gt;&#10;    &lt;/div&gt;&#10;&#10;    &lt;div id=&quot;ProducerFields&quot; class=&quot;mb-3&quot; style=&quot;display: none&quot;&gt;&#10;        &lt;label for=&quot;ProducerId&quot; class=&quot;form-label&quot;&gt;Wybierz producenta&lt;/label&gt;&#10;        &lt;select id=&quot;ProducerId&quot; name=&quot;ProducerId&quot; class=&quot;form-select&quot; onchange=&quot;loadPrograms(this.value)&quot;&gt;&#10;            &lt;option value=&quot;&quot;&gt;-- Wybierz producenta --&lt;/option&gt;&#10;            @foreach (var producer in Model.ProducerSelectList)&#10;            {&#10;                &lt;option value=&quot;@producer.Value&quot;&gt;@producer.Text&lt;/option&gt;&#10;            }&#10;        &lt;/select&gt;&#10;    &lt;/div&gt;&#10;&#10;    &lt;div id=&quot;ProgramFields&quot; class=&quot;mb-3&quot; &gt;&#10;        &lt;label for=&quot;ProgramId&quot; class=&quot;form-label&quot;&gt;Program / zasób&lt;/label&gt;&#10;        &lt;select id=&quot;ProgramId&quot; name=&quot;ProgramId&quot; class=&quot;form-select&quot; onchange=&quot;loadPermissions(this.value)&quot;&gt;&#10;            &lt;option value=&quot;&quot;&gt;-- Wybierz program / zasób --&lt;/option&gt;&#10;            @foreach (var program in Model.ProgramSelectList)&#10;            {&#10;                &lt;option value=&quot;@program.Value&quot;&gt;@program.Text&lt;/option&gt;&#10;            }&#10;        &lt;/select&gt;&#10;    &lt;/div &gt;&#10;&#10;    &lt;div id=&quot;PermissionFields&quot; class=&quot;mb-3&quot; style=&quot;display: block;&quot; &gt;&#10;        &lt;label for=&quot;PermissionId&quot; class=&quot;form-label&quot;&gt;Wybierz uprawnienie&lt;/label&gt;&#10;        &lt;select id=&quot;PermissionId&quot; name=&quot;PermissionId&quot; class=&quot;form-select&quot;&gt;&#10;            &lt;option value=&quot;&quot;&gt;-- Wybierz uprawnienie --&lt;/option&gt;&#10;        &lt;/select&gt;&#10;    &lt;/div&gt;&#10;&#10;    &lt;div id=&quot;DeviceTypeFields&quot; class=&quot;mb-3&quot; style=&quot;display: none;&quot;&gt;&#10;        &lt;label for=&quot;DeviceTypeId&quot; class=&quot;form-label&quot;&gt;Wybierz typ urządzenia&lt;/label&gt;&#10;        &lt;select id=&quot;DeviceTypeId&quot; name=&quot;DeviceTypeId&quot; class=&quot;form-select&quot; onchange=&quot;loadDevices(this.value)&quot;&gt;&#10;            &lt;option value=&quot;&quot;&gt;-- Wybierz typ urządzenia --&lt;/option&gt;&#10;            @foreach (var deviceType in Model.DeviceTypeSelectList)&#10;            {&#10;                &lt;option value=&quot;@deviceType.Value&quot;&gt;@deviceType.Text&lt;/option&gt;&#10;            }&#10;        &lt;/select&gt;&#10;    &lt;/div&gt;&#10;&#10;    &lt;div id=&quot;DeviceFields&quot; class=&quot;mb-3&quot; style=&quot;display: none;&quot;&gt;&#10;        &lt;label for=&quot;DeviceId&quot; class=&quot;form-label&quot;&gt;Wybierz urządzenie&lt;/label&gt;&#10;        &lt;select id=&quot;DeviceId&quot; name=&quot;DeviceId&quot; class=&quot;form-select&quot;&gt;&#10;            &lt;option value=&quot;&quot;&gt;-- Wybierz urządzenie --&lt;/option&gt;&#10;        &lt;/select&gt;&#10;    &lt;/div&gt;&#10;    &lt;!-- Ukryte pola na MessageText i ExpireDate, uzupełniane JS-em --&gt;&#10;    &lt;input type=&quot;hidden&quot; name=&quot;MessageText&quot; id=&quot;hiddenMessageText&quot; value=&quot;@Model.MessageText&quot; /&gt;&#10;    &lt;input type=&quot;hidden&quot; name=&quot;ExpireDate&quot; id=&quot;hiddenExpireDate&quot; value=&quot;@(Model.ExpireDate?.ToString(&quot;yyyy-MM-dd&quot;) ?? &quot;&quot;)&quot; /&gt;&#10;    &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;Dodaj do listy&lt;/button&gt;&#10;&lt;/form&gt;&#10;&#10;&lt;hr /&gt;&#10;&lt;!-- Widoczne pola MessageText i ExpireDate --&gt;&#10;&lt;label for=&quot;MessageTextVisible&quot; class=&quot;form-label&quot;&gt;Uwagi do wniosku (opcjonalne, max 50 znaków)&lt;/label&gt;&#10;&lt;textarea id=&quot;MessageTextVisible&quot; class=&quot;form-control&quot; maxlength=&quot;50&quot;&gt;@Model.MessageText&lt;/textarea&gt;&#10;&lt;div class=&quot;mb-3 mt-2&quot;&gt;&#10;    &lt;label for=&quot;ExpireDateVisible&quot; class=&quot;form-label&quot;&gt;Data wygaśnięcia wniosku&lt;/label&gt;&#10;    &lt;input type=&quot;date&quot; id=&quot;ExpireDateVisible&quot; class=&quot;form-control&quot; value=&quot;@(Model.ExpireDate?.ToString(&quot;yyyy-MM-dd&quot;) ?? &quot;&quot;)&quot; /&gt;&#10;&lt;/div&gt;&#10;&lt;script&gt;&#10;    // Przed wysłaniem formularza AddMessage przepisz wartości z widocznych pól do hidden inputów&#10;    document.getElementById('addMessageForm').addEventListener('submit', function(e) {&#10;        document.getElementById('hiddenMessageText').value = document.getElementById('MessageTextVisible').value;&#10;        document.getElementById('hiddenExpireDate').value = document.getElementById('ExpireDateVisible').value;&#10;    });&#10;&lt;/script&gt;&#10;&#10;&lt;hr /&gt;&#10;&lt;!-- Przycisk wysyłania zgłoszenia --&gt;&#10;&lt;form method=&quot;post&quot; asp-page-handler=&quot;SubmitApplication&quot;&gt;&#10;    &lt;button type=&quot;submit&quot; class=&quot;btn btn-success&quot;&gt;Wyślij zgłoszenie&lt;/button&gt;&#10;&lt;/form&gt;&#10;&#10;@section Scripts {&#10;    &lt;script&gt;&#10;        function loadDevices(deviceTypeId) {&#10;            const deviceSelect = document.getElementById(&quot;DeviceId&quot;);&#10;            deviceSelect.innerHTML = '&lt;option value=&quot;&quot;&gt;-- Wybierz urządzenie --&lt;/option&gt;';&#10;&#10;            if (deviceTypeId) {&#10;                fetch(`/SendApplication?handler=Devices&amp;deviceTypeId=${deviceTypeId}`)&#10;                    .then(response =&gt; response.json())&#10;                    .then(data =&gt; {&#10;                        if (data.success) {&#10;                            data.devices.forEach(device =&gt; {&#10;                                const option = document.createElement(&quot;option&quot;);&#10;                                option.value = device.id;&#10;                                option.textContent = device.name;&#10;                                deviceSelect.appendChild(option);&#10;                            });&#10;                        } else {&#10;                            alert(data.message || &quot;Wystąpił błąd podczas pobierania urządzeń.&quot;);&#10;                        }&#10;                    })&#10;                    .catch(error =&gt; {&#10;                        console.error(&quot;Błąd:&quot;, error);&#10;                        alert(&quot;Nie udało się pobrać urządzeń.&quot;);&#10;                    });&#10;            }&#10;        }&#10;    &lt;/script&gt;&#10;    &lt;script&gt;&#10;        function toggleFields() {&#10;            const type = document.getElementById(&quot;Type&quot;).value;&#10;            document.getElementById(&quot;ProgramFields&quot;).style.display = type === &quot;Program&quot; ? &quot;block&quot; : &quot;none&quot;;&#10;&#9;&#9;&#9;document.getElementById(&quot;ProducerFields&quot;).style.display = type === &quot;Program&quot; ? &quot;none&quot; : &quot;none&quot;;&#10;            document.getElementById(&quot;PermissionFields&quot;).style.display = type === &quot;Program&quot; ? &quot;block&quot; : &quot;none&quot;;&#10;            document.getElementById(&quot;DeviceFields&quot;).style.display = type === &quot;Device&quot; ? &quot;block&quot; : &quot;none&quot;;&#10;            document.getElementById(&quot;DeviceTypeFields&quot;).style.display = type === &quot;Device&quot; ? &quot;block&quot; : &quot;none&quot;&#10;        }&#10;&#10;        function loadPermissions(programId) {&#10;            const permissionSelect = document.getElementById(&quot;PermissionId&quot;);&#10;            permissionSelect.innerHTML = '&lt;option value=&quot;&quot;&gt;-- Wybierz uprawnienie --&lt;/option&gt;';&#10;&#10;            if (programId) {&#10;                fetch(`/SendApplication?handler=Permissions&amp;programId=${programId}`)&#10;                    .then(response =&gt; response.json())&#10;                    .then(data =&gt; {&#10;                        if (data.success) {&#10;                            data.permissions.forEach(permission =&gt; {&#10;                                const option = document.createElement(&quot;option&quot;);&#10;                                option.value = permission.id;&#10;                                option.textContent = permission.name;&#10;                                permissionSelect.appendChild(option);&#10;                            });&#10;                        } else {&#10;                            alert(data.message || &quot;Wystąpił błąd podczas pobierania uprawnień.&quot;);&#10;                        }&#10;                    })&#10;                    .catch(error =&gt; {&#10;                        console.error(&quot;Błąd:&quot;, error);&#10;                        alert(&quot;Nie udało się pobrać uprawnień.&quot;);&#10;                    });&#10;            }&#10;        }&#10;        function loadPrograms(programId) {&#10;            const permissionSelect = document.getElementById(&quot;ProgramId&quot;);&#10;            permissionSelect.innerHTML = '&lt;option value=&quot;&quot;&gt;-- Wybierz program / zasób --&lt;/option&gt;';&#10;            const permissionsSelect = document.getElementById(&quot;PermissionId&quot;);&#10;            permissionsSelect.innerHTML = '&lt;option value=&quot;&quot;&gt;-- Wybierz uprawnienie --&lt;/option&gt;';&#10;            if (programId) {&#10;                fetch(`/SendApplication?handler=Programs&amp;programId=${programId}`)&#10;                    .then(response =&gt; response.json())&#10;                    .then(data =&gt; {&#10;                        if (data.success) {&#10;                            data.permissions.forEach(permission =&gt; {&#10;                                const option = document.createElement(&quot;option&quot;);&#10;                                option.value = permission.id;&#10;                                option.textContent = permission.name;&#10;                                permissionSelect.appendChild(option);&#10;                            });&#10;                        } else {&#10;                            alert(data.message || &quot;Wystąpił błąd podczas pobierania programów / zasobów.&quot;);&#10;                        }&#10;                    })&#10;                    .catch(error =&gt; {&#10;                        console.error(&quot;Błąd:&quot;, error);&#10;                        alert(&quot;Nie udało się pobrać programów / zasobów.&quot;);&#10;                    });&#10;            }&#10;        }&#10;    &lt;/script&gt;&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/webapp/Pages/SendApplication.cshtml.cs">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/webapp/Pages/SendApplication.cshtml.cs" />
              <option name="originalContent" value="using Microsoft.AspNetCore.Mvc;&#10;using Microsoft.AspNetCore.Mvc.RazorPages;&#10;using Microsoft.AspNetCore.Mvc.Rendering;&#10;using webapp.Data;&#10;using webapp.Models;&#10;using System.Linq;&#10;using System.ComponentModel.DataAnnotations;&#10;using System.Text.Json;&#10;using Microsoft.EntityFrameworkCore.Metadata.Internal;&#10;using System;&#10;using webapp.Services;&#10;&#10;&#10;namespace webapp.Pages;&#10;&#10;public class SendApplicationModel : PageModel&#10;{&#10;    private readonly AppDbContext _context;&#10;&#10;    public SendApplicationModel(AppDbContext context)&#10;    {&#10;        _context = context;&#10;    }&#10;&#10;&#10;&#10;    [BindProperty]&#10;    public List&lt;Message&gt; PendingMessages { get; set; } = new();&#10;&#10;    [BindProperty]&#10;    public int? ProgramId { get; set; }&#10;    [BindProperty]&#10;    public int? ProducerId { get; set; }&#10;&#10;    [BindProperty]&#10;    public int? DeviceId { get; set; }&#10;&#10;    [BindProperty]&#10;    public int? PermissionId { get; set; }&#10;&#10;    [BindProperty]&#10;    public string? MessageText { get; set; } // &lt;-- teraz wspólne dla całości&#10;&#10;    [BindProperty]&#10;    [DataType(DataType.Date)]&#10;    public DateTime? ExpireDate { get; set; }&#10;&#10;    public IEnumerable&lt;SelectListItem&gt; ProgramSelectList { get; set; } = new List&lt;SelectListItem&gt;();&#10;    public IEnumerable&lt;SelectListItem&gt; ProducerSelectList { get; set; } = new List&lt;SelectListItem&gt;();&#10;    public IEnumerable&lt;SelectListItem&gt; DeviceSelectList { get; set; } = new List&lt;SelectListItem&gt;();&#10;    public IEnumerable&lt;SelectListItem&gt; PermissionSelectList { get; set; } = new List&lt;SelectListItem&gt;();&#10;    public IEnumerable&lt;SelectListItem&gt; DeviceTypeSelectList { get; set; } = new List&lt;SelectListItem&gt;();&#10;&#10;    public List&lt;User&gt; users = new();&#10;        &#10;    private ActionLoggerService _actionLoggerService;&#10;    &#10;    public string LoggedInUserDepartmentName { get; set; } = string.Empty;&#10;&#10;    public void OnGet()&#10;    {&#10;        LoadPendingMessagesFromSession();&#10;        LoadPrograms();&#10;        LoadDevices();&#10;        LoadPermissions();&#10;        LoadDeviceTypes();&#10;&#10;        users = _context.Users.ToList();&#10;    }&#10;&#10;&#10;    public IActionResult OnPostAddMessage(string type)&#10;    {&#10;        LoadPendingMessagesFromSession();&#10;        LoadMessageTextFromSession();&#10;&#10;        if (type == &quot;Program&quot; &amp;&amp; ProgramId.HasValue &amp;&amp; PermissionId.HasValue)&#10;        {&#10;            if (!PendingMessages.Any(m =&gt; m.ProgramId == ProgramId &amp;&amp; m.PermissionId == PermissionId))&#10;            {&#10;                PendingMessages.Add(new Message&#10;                {&#10;                    ProgramId = ProgramId,&#10;                    PermissionId = PermissionId&#10;                    // MessageText nie jest już przypisywany tutaj&#10;                });&#10;            }&#10;            else&#10;            {&#10;                ModelState.AddModelError(string.Empty, &quot;To uprawnienie już znajduje się na liście.&quot;);&#10;            }&#10;        }&#10;        else if (type == &quot;Device&quot; &amp;&amp; DeviceId.HasValue)&#10;        {&#10;            PendingMessages.Add(new Message&#10;            {&#10;                DeviceId = DeviceId&#10;                // MessageText nie jest już przypisywany tutaj&#10;            });&#10;        }&#10;        else&#10;        {&#10;            ModelState.AddModelError(string.Empty, &quot;Wszystkie wymagane pola muszą być wypełnione.&quot;);&#10;        }&#10;&#10;        SavePendingMessagesToSession();&#10;        SaveMessageTextToSession();&#10;        LoadPrograms();&#10;        LoadDeviceTypes();&#10;        LoadDevices();&#10;        LoadPermissions();&#10;        return Page();&#10;    }&#10;&#10;&#10;    public IActionResult OnPostRemoveMessage(int messageIndex)&#10;    {&#10;        LoadPendingMessagesFromSession();&#10;        LoadMessageTextFromSession();&#10;&#10;        if (messageIndex &gt;= 0 &amp;&amp; messageIndex &lt; PendingMessages.Count)&#10;        {&#10;            PendingMessages.RemoveAt(messageIndex);&#10;        }&#10;&#10;        SavePendingMessagesToSession();&#10;        SaveMessageTextToSession();&#10;        LoadPrograms();&#10;        LoadDeviceTypes();&#10;        LoadDevices();&#10;        LoadPermissions();&#10;        return Page();&#10;    }&#10;&#10;&#10;    public IActionResult OnPostSubmitApplication()&#10;    {&#10;        _actionLoggerService = new ActionLoggerService(_context);&#10;        var loggedInUserId = HttpContext.Session.GetInt32(&quot;ApplicationUserId&quot;);&#10;&#10;        if (loggedInUserId == null)&#10;        {&#10;            ModelState.AddModelError(string.Empty, &quot;Nie jesteś zalogowany.&quot;);&#10;            return Page();&#10;        }&#10;        LoadPendingMessagesFromSession();&#10;        LoadMessageTextFromSession();&#10;&#10;        int newApplicationId = (_context.MessageLinks.Max(ml =&gt; (int?)ml.ApplicationId) ?? 0) + 1;&#10;        int newActionId = 1;&#10;        if(_context.ActionHistories.Count() &gt; 0)&#10;        {&#10;            newActionId = _context.ActionHistories.Max(a =&gt; a.ActionHistoryId) + 1;&#10;        }&#10;        foreach (var message in PendingMessages)&#10;        {&#10;            message.UserId = loggedInUserId.Value;&#10;            message.RequestDate = DateTime.Now;&#10;            _context.Messages.Add(message);&#10;            _context.SaveChanges(); // Zapisujemy, aby uzyska� MessageId&#10;&#10;            // Tworzenie nowego urz�dzenia, je�li wniosek dotyczy urz�dzenia&#10;            if (message.DeviceId.HasValue)&#10;            {&#10;                var existingDevice = _context.Devices.FirstOrDefault(d =&gt; d.Id == message.DeviceId.Value);&#10;                if (existingDevice != null)&#10;                {&#10;                    var newDevice = new Device&#10;                    {&#10;                        Name = existingDevice.Name,&#10;                        DeviceTypeId = existingDevice.DeviceTypeId,&#10;                        Serial = existingDevice.Serial,&#10;                        StatusId = _context.Statuses.Min(u =&gt; u.Id), // Ustawienie statusu na &quot;oczekuj�cy&quot;&#10;                        StatusUpdate = DateTime.Now&#10;                    };&#10;                    _context.Devices.Add(newDevice);&#10;                    _context.SaveChanges();&#10;&#10;                    // Aktualizacja wiadomo�ci, aby wskazywa�a na nowe urz�dzenie&#10;                    message.DeviceId = newDevice.Id;&#10;                    _context.Messages.Update(message);&#10;                }&#10;            }&#10;            if (message.ProgramId.HasValue &amp;&amp; message.PermissionId.HasValue)&#10;            {&#10;                var userPermission = new UserPermission&#10;                {&#10;                    UserId = loggedInUserId.Value,&#10;                    PermissionId = message.PermissionId.Value,&#10;                    StatusId = _context.Statuses.Min(u =&gt; u.Id), // Status &quot;oczekuj�cy&quot;&#10;                    RequestDate = DateTime.Now&#10;                };&#10;                _context.UserPermissions.Add(userPermission);&#10;                _context.SaveChanges();&#10;&#10;                // Przypisanie UPermissionId do wiadomo�ci&#10;                message.UPermissionsId = userPermission.Id;&#10;                _context.Messages.Update(message);&#10;            }&#10;&#10;            // Dodanie MessageLink do bazy&#10;            var messageLink = new MessageLink&#10;            {&#10;                ApplicationId = newApplicationId,&#10;                MessageId = message.Id,&#10;                DegreeId = _context.Degrees.First(d =&gt; d.Id == _context.Users.First(u =&gt; u.Id == loggedInUserId.Value).DegreeId)?.ManagerId ?? 0&#10;            };&#10;            _context.MessageLinks.Add(messageLink);&#10;            _actionLoggerService.Log(&#10;                HttpContext.Session.GetInt32(&quot;UserId&quot;) ?? 0,&#10;                message.UPermissionsId,&#10;                message.DeviceId,&#10;                messageLink.ApplicationId,&#10;                4,&#10;                newActionId&#10;            );&#10;        }&#10;        // Dodanie ApplicationDetails z MessageText i ExpireDate&#10;        if (!string.IsNullOrWhiteSpace(MessageText))&#10;        {&#10;            var appDetails = new ApplicationDetails&#10;            {&#10;                ApplicationId = newApplicationId,&#10;                Message = MessageText,&#10;                ExpireDate = ExpireDate ?? DateTime.UnixEpoch&#10;            };&#10;            _context.ApplicationDetails.Add(appDetails);&#10;        }&#10;        _context.SaveChanges();&#10;        PendingMessages.Clear();&#10;        MessageText = string.Empty;&#10;        ExpireDate = null;&#10;        SavePendingMessagesToSession();&#10;        SaveMessageTextToSession();&#10;        TempData[&quot;SuccessMessage&quot;] = &quot;Wniosek został pomyślnie złożony.&quot;;&#10;        return RedirectToPage(&quot;/Index&quot;);&#10;    }&#10;&#10;    private void LoadDeviceTypes()&#10;    {&#10;        DeviceTypeSelectList = _context.DeviceTypes&#10;            .Select(dt =&gt; new SelectListItem&#10;            {&#10;                Value = dt.Id.ToString(),&#10;                Text = dt.Name&#10;            })&#10;            .ToList();&#10;    }&#10;&#10;&#10;    private void LoadPrograms()&#10;    {&#10;        var loggedInUserId = HttpContext.Session.GetInt32(&quot;ApplicationUserId&quot;);&#10;        LoggedInUserDepartmentName = _context.Departments.First(de =&gt; de.Id == _context.Degrees.First(d =&gt; d.Id == _context.Users.FirstOrDefault(u =&gt; u.Id == loggedInUserId.Value).DegreeId).DepartmentId).Name;&#10;        ProducerSelectList = _context.Producents.Where(p =&gt; p.Name == LoggedInUserDepartmentName)&#10;            .Select(p =&gt; new SelectListItem&#10;            {&#10;                Value = p.Id.ToString(),&#10;                Text = p.Name&#10;            })&#10;            .ToList();&#10;        if (ProducerSelectList.Any())&#10;        {&#10;            ProgramSelectList = _context.Programs&#10;                .Where(p =&gt; p.ProducerId.ToString() == ProducerSelectList.First().Value)&#10;                .Select(p =&gt; new SelectListItem&#10;                {&#10;                    Value = p.Id.ToString(),&#10;                    Text = p.Name&#10;                })&#10;                .ToList();&#10;        }&#10;    }&#10;&#10;    private void LoadDevices()&#10;    {&#10;        DeviceSelectList = _context.Devices.Where(e =&gt; e.StatusId == _context.Statuses.Min(e =&gt; e.Id) + 4)&#10;            .Select(d =&gt; new SelectListItem&#10;            {&#10;                Value = d.Id.ToString(),&#10;                Text = d.Name&#10;            })&#10;            .ToList();&#10;    }&#10;&#10;    private void LoadPermissions()&#10;    {&#10;        var loggedInUserId = HttpContext.Session.GetInt32(&quot;ApplicationUserId&quot;);&#10;&#10;        if (loggedInUserId == null || !ProgramId.HasValue)&#10;        {&#10;            PermissionSelectList = new List&lt;SelectListItem&gt;();&#10;            return;&#10;        }&#10;&#10;        // Pobieranie istniej�cych uprawnie� u�ytkownika (w tym oczekuj�cych i zaakceptowanych)&#10;        var existingPermissions = _context.UserPermissions&#10;            .Where(up =&gt; up.UserId == loggedInUserId.Value &amp;&amp; up.StatusId != 6) // Pomijamy odrzucone&#10;            .Select(up =&gt; up.PermissionId)&#10;            .ToHashSet();&#10;&#10;        // Pobieranie uprawnie� oznaczonych jako &quot;odrzucone&quot;&#10;        var rejectedPermissions = _context.UserPermissions&#10;            .Where(up =&gt; up.UserId == loggedInUserId.Value &amp;&amp; up.StatusId == 6)&#10;            .Select(up =&gt; up.PermissionId)&#10;            .ToHashSet();&#10;&#10;        // Pobieranie dost�pnych uprawnie� dla wybranego programu&#10;        PermissionSelectList = _context.Permissions&#10;            .Where(p =&gt; p.ProgramId == ProgramId.Value &amp;&amp; (!existingPermissions.Contains(p.Id) || rejectedPermissions.Contains(p.Id)))&#10;            .Select(p =&gt; new SelectListItem&#10;            {&#10;                Value = p.Id.ToString(),&#10;                Text = p.Name + (rejectedPermissions.Contains(p.Id) ? &quot; (Odrzucone)&quot; : &quot;&quot;)&#10;            })&#10;            .ToList();&#10;    }&#10;    public JsonResult OnGetPermissions(int programId)&#10;    {&#10;        var loggedInUserId = HttpContext.Session.GetInt32(&quot;ApplicationUserId&quot;);&#10;&#10;        if (loggedInUserId == null)&#10;        {&#10;            return new JsonResult(new { success = false, message = &quot;Nie jesteś zalogowany.&quot; });&#10;        }&#10;        var DeletedMessages = new List&lt;Message&gt;();&#10;        var serializedDM = HttpContext.Session.GetString(&quot;DeletedMessages&quot;);&#10;        if (!string.IsNullOrEmpty(serializedDM))&#10;        {&#10;            DeletedMessages = JsonSerializer.Deserialize&lt;List&lt;Message&gt;&gt;(serializedDM) ?? new List&lt;Message&gt;();&#10;        }&#10;&#10;        var DMUP = DeletedMessages.Select(dm =&gt; dm.UPermissionsId).ToList();&#10;        var PID = DeletedMessages.Select(dm =&gt; dm.PermissionId).ToList();&#10;&#10;        var existingPermissions = _context.UserPermissions&#10;            .Where(up =&gt; up.UserId == loggedInUserId.Value &amp;&amp; up.StatusId != 6) // Pomijamy odrzucone&#10;            .Select(up =&gt; up.PermissionId)&#10;            .ToHashSet();&#10;&#10;        // Pobieranie uprawnie� oznaczonych jako &quot;odrzucone&quot;&#10;        var rejectedPermissions = _context.UserPermissions&#10;            .Where(up =&gt; up.UserId == loggedInUserId.Value &amp;&amp; up.StatusId == 6)&#10;            .Select(up =&gt; up.PermissionId)&#10;            .ToHashSet();&#10;&#10;        var permissions = _context.Permissions&#10;            .Where(p =&gt; p.ProgramId == programId &amp;&amp; (!existingPermissions.Contains(p.Id) || PID.Contains(p.Id)))&#10;            .Select(p =&gt; new { id = p.Id, name = p.Name })&#10;            .ToList();&#10;&#10;        return new JsonResult(new { success = true, permissions });&#10;    }&#10;    public JsonResult OnGetDevices(int deviceTypeId)&#10;    {&#10;        var devices = _context.Devices.Where(d =&gt; d.StatusId == 5)&#10;            .Where(d =&gt; d.DeviceTypeId == deviceTypeId)&#10;            .Select(d =&gt; new { id = d.Id, name = d.Name })&#10;            .ToList();&#10;&#10;        return new JsonResult(new { success = true, devices });&#10;    }&#10;    public JsonResult OnGetPrograms(int programId)&#10;    {&#10;        var loggedInUserId = HttpContext.Session.GetInt32(&quot;ApplicationUserId&quot;);&#10;&#10;        if (loggedInUserId == null)&#10;        {&#10;            return new JsonResult(new { success = false, message = &quot;Nie jeste� zalogowany.&quot; });&#10;        }&#10;&#10;        var permissions = _context.Programs.Where(p =&gt; p.ProducerId == programId);&#10;&#10;        return new JsonResult(new { success = true, permissions });&#10;    }&#10;    public string GetDeviceName(int deviceId)&#10;    {&#10;        var device = _context.Devices.FirstOrDefault(d =&gt; d.Id == deviceId);&#10;        return device?.Name ?? &quot;Nieznane urządzenie&quot;;&#10;    }&#10;    public string GetDeviceType(int deviceId)&#10;    {&#10;        var device = _context.DeviceTypes.FirstOrDefault(d =&gt; d.Id == _context.Devices.FirstOrDefault(e =&gt; e.Id == deviceId).DeviceTypeId);&#10;        return device?.Name ?? &quot;Nieznane urządzenie&quot;;&#10;    }&#10;&#10;    public string GetProgramName(int programId)&#10;    {&#10;        var program = _context.Programs.FirstOrDefault(p =&gt; p.Id == programId);&#10;        return program?.Name ?? &quot;Nieznany program / zasób&quot;;&#10;    }&#10;&#10;    public string GetPermissionName(int permissionId)&#10;    {&#10;        var permission = _context.Permissions.FirstOrDefault(p =&gt; p.Id == permissionId);&#10;        return permission?.Name ?? &quot;Nieznane uprawnienie&quot;;&#10;    }&#10;    private void SavePendingMessagesToSession()&#10;    {&#10;        var serializedMessages = JsonSerializer.Serialize(PendingMessages);&#10;        HttpContext.Session.SetString(&quot;PendingMessages&quot;, serializedMessages);&#10;    }&#10;    private void SaveMessageTextToSession()&#10;    {&#10;        HttpContext.Session.SetString(&quot;PendingMessageText&quot;, MessageText ?? string.Empty);&#10;        HttpContext.Session.SetString(&quot;PendingExpireDate&quot;, ExpireDate?.ToString(&quot;o&quot;) ?? string.Empty);&#10;    }&#10;    private void LoadPendingMessagesFromSession()&#10;    {&#10;        var serializedMessages = HttpContext.Session.GetString(&quot;PendingMessages&quot;);&#10;        if (!string.IsNullOrEmpty(serializedMessages))&#10;        {&#10;            PendingMessages = JsonSerializer.Deserialize&lt;List&lt;Message&gt;&gt;(serializedMessages) ?? new List&lt;Message&gt;();&#10;        }&#10;    }&#10;    private void LoadMessageTextFromSession()&#10;    {&#10;        MessageText = HttpContext.Session.GetString(&quot;PendingMessageText&quot;) ?? string.Empty;&#10;        var expireDateStr = HttpContext.Session.GetString(&quot;PendingExpireDate&quot;);&#10;        if (!string.IsNullOrEmpty(expireDateStr) &amp;&amp; DateTime.TryParse(expireDateStr, out var dt))&#10;            ExpireDate = dt;&#10;        else&#10;            ExpireDate = null;&#10;    }&#10;&#10;}&#10;" />
              <option name="updatedContent" value="using Microsoft.AspNetCore.Mvc;&#10;using Microsoft.AspNetCore.Mvc.RazorPages;&#10;using Microsoft.AspNetCore.Mvc.Rendering;&#10;using webapp.Data;&#10;using webapp.Models;&#10;using System.Linq;&#10;using System.ComponentModel.DataAnnotations;&#10;using System.Text.Json;&#10;using Microsoft.EntityFrameworkCore.Metadata.Internal;&#10;using System;&#10;using webapp.Services;&#10;&#10;&#10;namespace webapp.Pages;&#10;&#10;public class SendApplicationModel : PageModel&#10;{&#10;    private readonly AppDbContext _context;&#10;&#10;    public SendApplicationModel(AppDbContext context)&#10;    {&#10;        _context = context;&#10;    }&#10;&#10;&#10;&#10;    [BindProperty]&#10;    public List&lt;Message&gt; PendingMessages { get; set; } = new();&#10;&#10;    [BindProperty]&#10;    public int? ProgramId { get; set; }&#10;    [BindProperty]&#10;    public int? ProducerId { get; set; }&#10;&#10;    [BindProperty]&#10;    public int? DeviceId { get; set; }&#10;&#10;    [BindProperty]&#10;    public int? PermissionId { get; set; }&#10;&#10;    [BindProperty]&#10;    public string? MessageText { get; set; } // &lt;-- teraz wspólne dla całości&#10;&#10;    [BindProperty]&#10;    [DataType(DataType.Date)]&#10;    public DateTime? ExpireDate { get; set; }&#10;&#10;    public IEnumerable&lt;SelectListItem&gt; ProgramSelectList { get; set; } = new List&lt;SelectListItem&gt;();&#10;    public IEnumerable&lt;SelectListItem&gt; ProducerSelectList { get; set; } = new List&lt;SelectListItem&gt;();&#10;    public IEnumerable&lt;SelectListItem&gt; DeviceSelectList { get; set; } = new List&lt;SelectListItem&gt;();&#10;    public IEnumerable&lt;SelectListItem&gt; PermissionSelectList { get; set; } = new List&lt;SelectListItem&gt;();&#10;    public IEnumerable&lt;SelectListItem&gt; DeviceTypeSelectList { get; set; } = new List&lt;SelectListItem&gt;();&#10;&#10;    public List&lt;User&gt; users = new();&#10;        &#10;    private ActionLoggerService _actionLoggerService;&#10;    &#10;    public string LoggedInUserDepartmentName { get; set; } = string.Empty;&#10;&#10;    public void OnGet()&#10;    {&#10;        LoadPendingMessagesFromSession();&#10;        LoadPrograms();&#10;        LoadDevices();&#10;        LoadPermissions();&#10;        LoadDeviceTypes();&#10;&#10;        users = _context.Users.ToList();&#10;    }&#10;&#10;&#10;    public IActionResult OnPostAddMessage(string type)&#10;    {&#10;        // Pobierz aktualne wartości z formularza (nie są automatycznie bindowane przy tym handlerze)&#10;        MessageText = Request.Form[&quot;MessageText&quot;];&#10;        if (DateTime.TryParse(Request.Form[&quot;ExpireDate&quot;], out var expireDate))&#10;            ExpireDate = expireDate;&#10;        else&#10;            ExpireDate = null;&#10;&#10;        LoadPendingMessagesFromSession();&#10;        // SaveMessageTextToSession() przeniesione niżej&#10;&#10;        if (type == &quot;Program&quot; &amp;&amp; ProgramId.HasValue &amp;&amp; PermissionId.HasValue)&#10;        {&#10;            if (!PendingMessages.Any(m =&gt; m.ProgramId == ProgramId &amp;&amp; m.PermissionId == PermissionId))&#10;            {&#10;                PendingMessages.Add(new Message&#10;                {&#10;                    ProgramId = ProgramId,&#10;                    PermissionId = PermissionId&#10;                });&#10;            }&#10;            else&#10;            {&#10;                ModelState.AddModelError(string.Empty, &quot;To uprawnienie już znajduje się na liście.&quot;);&#10;            }&#10;        }&#10;        else if (type == &quot;Device&quot; &amp;&amp; DeviceId.HasValue)&#10;        {&#10;            PendingMessages.Add(new Message&#10;            {&#10;                DeviceId = DeviceId&#10;            });&#10;        }&#10;        else&#10;        {&#10;            ModelState.AddModelError(string.Empty, &quot;Wszystkie wymagane pola muszą być wypełnione.&quot;);&#10;        }&#10;&#10;        SavePendingMessagesToSession();&#10;        SaveMessageTextToSession();&#10;        LoadPrograms();&#10;        LoadDeviceTypes();&#10;        LoadDevices();&#10;        LoadPermissions();&#10;        return Page();&#10;    }&#10;&#10;&#10;    public IActionResult OnPostRemoveMessage(int messageIndex)&#10;    {&#10;        // Pobierz aktualne wartości z formularza (nie są automatycznie bindowane przy tym handlerze)&#10;        MessageText = Request.Form[&quot;MessageText&quot;];&#10;        if (DateTime.TryParse(Request.Form[&quot;ExpireDate&quot;], out var expireDate))&#10;            ExpireDate = expireDate;&#10;        else&#10;            ExpireDate = null;&#10;&#10;        LoadPendingMessagesFromSession();&#10;        // SaveMessageTextToSession() przeniesione niżej&#10;&#10;        if (messageIndex &gt;= 0 &amp;&amp; messageIndex &lt; PendingMessages.Count)&#10;        {&#10;            PendingMessages.RemoveAt(messageIndex);&#10;        }&#10;&#10;        SavePendingMessagesToSession();&#10;        SaveMessageTextToSession();&#10;        LoadPrograms();&#10;        LoadDeviceTypes();&#10;        LoadDevices();&#10;        LoadPermissions();&#10;        return Page();&#10;    }&#10;&#10;&#10;    public IActionResult OnPostSubmitApplication()&#10;    {&#10;        _actionLoggerService = new ActionLoggerService(_context);&#10;        var loggedInUserId = HttpContext.Session.GetInt32(&quot;ApplicationUserId&quot;);&#10;&#10;        if (loggedInUserId == null)&#10;        {&#10;            ModelState.AddModelError(string.Empty, &quot;Nie jesteś zalogowany.&quot;);&#10;            return Page();&#10;        }&#10;        LoadPendingMessagesFromSession();&#10;        LoadMessageTextFromSession();&#10;&#10;        int newApplicationId = (_context.MessageLinks.Max(ml =&gt; (int?)ml.ApplicationId) ?? 0) + 1;&#10;        int newActionId = 1;&#10;        if(_context.ActionHistories.Count() &gt; 0)&#10;        {&#10;            newActionId = _context.ActionHistories.Max(a =&gt; a.ActionHistoryId) + 1;&#10;        }&#10;        foreach (var message in PendingMessages)&#10;        {&#10;            message.UserId = loggedInUserId.Value;&#10;            message.RequestDate = DateTime.Now;&#10;            _context.Messages.Add(message);&#10;            _context.SaveChanges(); // Zapisujemy, aby uzyska� MessageId&#10;&#10;            // Tworzenie nowego urz�dzenia, je�li wniosek dotyczy urz�dzenia&#10;            if (message.DeviceId.HasValue)&#10;            {&#10;                var existingDevice = _context.Devices.FirstOrDefault(d =&gt; d.Id == message.DeviceId.Value);&#10;                if (existingDevice != null)&#10;                {&#10;                    var newDevice = new Device&#10;                    {&#10;                        Name = existingDevice.Name,&#10;                        DeviceTypeId = existingDevice.DeviceTypeId,&#10;                        Serial = existingDevice.Serial,&#10;                        StatusId = _context.Statuses.Min(u =&gt; u.Id), // Ustawienie statusu na &quot;oczekuj�cy&quot;&#10;                        StatusUpdate = DateTime.Now&#10;                    };&#10;                    _context.Devices.Add(newDevice);&#10;                    _context.SaveChanges();&#10;&#10;                    // Aktualizacja wiadomo�ci, aby wskazywa�a na nowe urz�dzenie&#10;                    message.DeviceId = newDevice.Id;&#10;                    _context.Messages.Update(message);&#10;                }&#10;            }&#10;            if (message.ProgramId.HasValue &amp;&amp; message.PermissionId.HasValue)&#10;            {&#10;                var userPermission = new UserPermission&#10;                {&#10;                    UserId = loggedInUserId.Value,&#10;                    PermissionId = message.PermissionId.Value,&#10;                    StatusId = _context.Statuses.Min(u =&gt; u.Id), // Status &quot;oczekuj�cy&quot;&#10;                    RequestDate = DateTime.Now&#10;                };&#10;                _context.UserPermissions.Add(userPermission);&#10;                _context.SaveChanges();&#10;&#10;                // Przypisanie UPermissionId do wiadomo�ci&#10;                message.UPermissionsId = userPermission.Id;&#10;                _context.Messages.Update(message);&#10;            }&#10;&#10;            // Dodanie MessageLink do bazy&#10;            var messageLink = new MessageLink&#10;            {&#10;                ApplicationId = newApplicationId,&#10;                MessageId = message.Id,&#10;                DegreeId = _context.Degrees.First(d =&gt; d.Id == _context.Users.First(u =&gt; u.Id == loggedInUserId.Value).DegreeId)?.ManagerId ?? 0&#10;            };&#10;            _context.MessageLinks.Add(messageLink);&#10;            _actionLoggerService.Log(&#10;                HttpContext.Session.GetInt32(&quot;UserId&quot;) ?? 0,&#10;                message.UPermissionsId,&#10;                message.DeviceId,&#10;                messageLink.ApplicationId,&#10;                4,&#10;                newActionId&#10;            );&#10;        }&#10;        // Dodanie ApplicationDetails z MessageText i ExpireDate&#10;        if (!string.IsNullOrWhiteSpace(MessageText))&#10;        {&#10;            var appDetails = new ApplicationDetails&#10;            {&#10;                ApplicationId = newApplicationId,&#10;                Message = MessageText,&#10;                ExpireDate = ExpireDate ?? DateTime.UnixEpoch&#10;            };&#10;            _context.ApplicationDetails.Add(appDetails);&#10;        }&#10;        _context.SaveChanges();&#10;        PendingMessages.Clear();&#10;        MessageText = string.Empty;&#10;        ExpireDate = null;&#10;        SavePendingMessagesToSession();&#10;        SaveMessageTextToSession();&#10;        TempData[&quot;SuccessMessage&quot;] = &quot;Wniosek został pomyślnie złożony.&quot;;&#10;        return RedirectToPage(&quot;/Index&quot;);&#10;    }&#10;&#10;    private void LoadDeviceTypes()&#10;    {&#10;        DeviceTypeSelectList = _context.DeviceTypes&#10;            .Select(dt =&gt; new SelectListItem&#10;            {&#10;                Value = dt.Id.ToString(),&#10;                Text = dt.Name&#10;            })&#10;            .ToList();&#10;    }&#10;&#10;&#10;    private void LoadPrograms()&#10;    {&#10;        var loggedInUserId = HttpContext.Session.GetInt32(&quot;ApplicationUserId&quot;);&#10;        LoggedInUserDepartmentName = _context.Departments.First(de =&gt; de.Id == _context.Degrees.First(d =&gt; d.Id == _context.Users.FirstOrDefault(u =&gt; u.Id == loggedInUserId.Value).DegreeId).DepartmentId).Name;&#10;        ProducerSelectList = _context.Producents.Where(p =&gt; p.Name == LoggedInUserDepartmentName)&#10;            .Select(p =&gt; new SelectListItem&#10;            {&#10;                Value = p.Id.ToString(),&#10;                Text = p.Name&#10;            })&#10;            .ToList();&#10;        if (ProducerSelectList.Any())&#10;        {&#10;            ProgramSelectList = _context.Programs&#10;                .Where(p =&gt; p.ProducerId.ToString() == ProducerSelectList.First().Value)&#10;                .Select(p =&gt; new SelectListItem&#10;                {&#10;                    Value = p.Id.ToString(),&#10;                    Text = p.Name&#10;                })&#10;                .ToList();&#10;        }&#10;    }&#10;&#10;    private void LoadDevices()&#10;    {&#10;        DeviceSelectList = _context.Devices.Where(e =&gt; e.StatusId == _context.Statuses.Min(e =&gt; e.Id) + 4)&#10;            .Select(d =&gt; new SelectListItem&#10;            {&#10;                Value = d.Id.ToString(),&#10;                Text = d.Name&#10;            })&#10;            .ToList();&#10;    }&#10;&#10;    private void LoadPermissions()&#10;    {&#10;        var loggedInUserId = HttpContext.Session.GetInt32(&quot;ApplicationUserId&quot;);&#10;&#10;        if (loggedInUserId == null || !ProgramId.HasValue)&#10;        {&#10;            PermissionSelectList = new List&lt;SelectListItem&gt;();&#10;            return;&#10;        }&#10;&#10;        // Pobieranie istniej�cych uprawnie� u�ytkownika (w tym oczekuj�cych i zaakceptowanych)&#10;        var existingPermissions = _context.UserPermissions&#10;            .Where(up =&gt; up.UserId == loggedInUserId.Value &amp;&amp; up.StatusId != 6) // Pomijamy odrzucone&#10;            .Select(up =&gt; up.PermissionId)&#10;            .ToHashSet();&#10;&#10;        // Pobieranie uprawnie� oznaczonych jako &quot;odrzucone&quot;&#10;        var rejectedPermissions = _context.UserPermissions&#10;            .Where(up =&gt; up.UserId == loggedInUserId.Value &amp;&amp; up.StatusId == 6)&#10;            .Select(up =&gt; up.PermissionId)&#10;            .ToHashSet();&#10;&#10;        // Pobieranie dost�pnych uprawnie� dla wybranego programu&#10;        PermissionSelectList = _context.Permissions&#10;            .Where(p =&gt; p.ProgramId == ProgramId.Value &amp;&amp; (!existingPermissions.Contains(p.Id) || rejectedPermissions.Contains(p.Id)))&#10;            .Select(p =&gt; new SelectListItem&#10;            {&#10;                Value = p.Id.ToString(),&#10;                Text = p.Name + (rejectedPermissions.Contains(p.Id) ? &quot; (Odrzucone)&quot; : &quot;&quot;)&#10;            })&#10;            .ToList();&#10;    }&#10;    public JsonResult OnGetPermissions(int programId)&#10;    {&#10;        var loggedInUserId = HttpContext.Session.GetInt32(&quot;ApplicationUserId&quot;);&#10;&#10;        if (loggedInUserId == null)&#10;        {&#10;            return new JsonResult(new { success = false, message = &quot;Nie jesteś zalogowany.&quot; });&#10;        }&#10;        var DeletedMessages = new List&lt;Message&gt;();&#10;        var serializedDM = HttpContext.Session.GetString(&quot;DeletedMessages&quot;);&#10;        if (!string.IsNullOrEmpty(serializedDM))&#10;        {&#10;            DeletedMessages = JsonSerializer.Deserialize&lt;List&lt;Message&gt;&gt;(serializedDM) ?? new List&lt;Message&gt;();&#10;        }&#10;&#10;        var DMUP = DeletedMessages.Select(dm =&gt; dm.UPermissionsId).ToList();&#10;        var PID = DeletedMessages.Select(dm =&gt; dm.PermissionId).ToList();&#10;&#10;        var existingPermissions = _context.UserPermissions&#10;            .Where(up =&gt; up.UserId == loggedInUserId.Value &amp;&amp; up.StatusId != 6) // Pomijamy odrzucone&#10;            .Select(up =&gt; up.PermissionId)&#10;            .ToHashSet();&#10;&#10;        // Pobieranie uprawnie� oznaczonych jako &quot;odrzucone&quot;&#10;        var rejectedPermissions = _context.UserPermissions&#10;            .Where(up =&gt; up.UserId == loggedInUserId.Value &amp;&amp; up.StatusId == 6)&#10;            .Select(up =&gt; up.PermissionId)&#10;            .ToHashSet();&#10;&#10;        var permissions = _context.Permissions&#10;            .Where(p =&gt; p.ProgramId == programId &amp;&amp; (!existingPermissions.Contains(p.Id) || PID.Contains(p.Id)))&#10;            .Select(p =&gt; new { id = p.Id, name = p.Name })&#10;            .ToList();&#10;&#10;        return new JsonResult(new { success = true, permissions });&#10;    }&#10;    public JsonResult OnGetDevices(int deviceTypeId)&#10;    {&#10;        var devices = _context.Devices.Where(d =&gt; d.StatusId == 5)&#10;            .Where(d =&gt; d.DeviceTypeId == deviceTypeId)&#10;            .Select(d =&gt; new { id = d.Id, name = d.Name })&#10;            .ToList();&#10;&#10;        return new JsonResult(new { success = true, devices });&#10;    }&#10;    public JsonResult OnGetPrograms(int programId)&#10;    {&#10;        var loggedInUserId = HttpContext.Session.GetInt32(&quot;ApplicationUserId&quot;);&#10;&#10;        if (loggedInUserId == null)&#10;        {&#10;            return new JsonResult(new { success = false, message = &quot;Nie jeste� zalogowany.&quot; });&#10;        }&#10;&#10;        var permissions = _context.Programs.Where(p =&gt; p.ProducerId == programId);&#10;&#10;        return new JsonResult(new { success = true, permissions });&#10;    }&#10;    public string GetDeviceName(int deviceId)&#10;    {&#10;        var device = _context.Devices.FirstOrDefault(d =&gt; d.Id == deviceId);&#10;        return device?.Name ?? &quot;Nieznane urządzenie&quot;;&#10;    }&#10;    public string GetDeviceType(int deviceId)&#10;    {&#10;        var device = _context.DeviceTypes.FirstOrDefault(d =&gt; d.Id == _context.Devices.FirstOrDefault(e =&gt; e.Id == deviceId).DeviceTypeId);&#10;        return device?.Name ?? &quot;Nieznane urządzenie&quot;;&#10;    }&#10;&#10;    public string GetProgramName(int programId)&#10;    {&#10;        var program = _context.Programs.FirstOrDefault(p =&gt; p.Id == programId);&#10;        return program?.Name ?? &quot;Nieznany program / zasób&quot;;&#10;    }&#10;&#10;    public string GetPermissionName(int permissionId)&#10;    {&#10;        var permission = _context.Permissions.FirstOrDefault(p =&gt; p.Id == permissionId);&#10;        return permission?.Name ?? &quot;Nieznane uprawnienie&quot;;&#10;    }&#10;    private void SavePendingMessagesToSession()&#10;    {&#10;        var serializedMessages = JsonSerializer.Serialize(PendingMessages);&#10;        HttpContext.Session.SetString(&quot;PendingMessages&quot;, serializedMessages);&#10;    }&#10;    private void SaveMessageTextToSession()&#10;    {&#10;        HttpContext.Session.SetString(&quot;PendingMessageText&quot;, MessageText ?? string.Empty);&#10;        HttpContext.Session.SetString(&quot;PendingExpireDate&quot;, ExpireDate?.ToString(&quot;o&quot;) ?? string.Empty);&#10;    }&#10;    private void LoadPendingMessagesFromSession()&#10;    {&#10;        var serializedMessages = HttpContext.Session.GetString(&quot;PendingMessages&quot;);&#10;        if (!string.IsNullOrEmpty(serializedMessages))&#10;        {&#10;            PendingMessages = JsonSerializer.Deserialize&lt;List&lt;Message&gt;&gt;(serializedMessages) ?? new List&lt;Message&gt;();&#10;        }&#10;    }&#10;    private void LoadMessageTextFromSession()&#10;    {&#10;        MessageText = HttpContext.Session.GetString(&quot;PendingMessageText&quot;) ?? string.Empty;&#10;        var expireDateStr = HttpContext.Session.GetString(&quot;PendingExpireDate&quot;);&#10;        if (!string.IsNullOrEmpty(expireDateStr) &amp;&amp; DateTime.TryParse(expireDateStr, out var dt))&#10;            ExpireDate = dt;&#10;        else&#10;            ExpireDate = null;&#10;    }&#10;&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>